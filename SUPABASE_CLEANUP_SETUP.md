# ğŸ—‘ï¸ Supabaseè‡ªå‹•å‰Šé™¤æ©Ÿèƒ½ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

Shopifyæ³¨æ–‡ã¨é€£æºã—ã¦ã€æœªæ³¨æ–‡ã®å¤ã„ç”»åƒã‚’è‡ªå‹•å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

---

## ğŸ“‹ æ©Ÿèƒ½

- âœ… **æ³¨æ–‡æ¸ˆã¿ã®ç”»åƒã¯æ°¸ä¹…ä¿å­˜**
- âœ… **æœªæ³¨æ–‡ã®ç”»åƒã¯30æ—¥å¾Œã«è‡ªå‹•å‰Šé™¤**
- âœ… **å®Œå…¨è‡ªå‹•åŒ–**ï¼ˆæ‰‹å‹•æ“ä½œä¸è¦ï¼‰

---

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ

1. **Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**ã‚’é–‹ã: https://supabase.com/dashboard
2. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**ã‚’é¸æŠ: `printaize`
3. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã® **ã€ŒSQL Editorã€** ã‚’ã‚¯ãƒªãƒƒã‚¯
4. **ã€ŒNew queryã€** ã‚’ã‚¯ãƒªãƒƒã‚¯
5. `supabase-setup.sql` ã®å†…å®¹ã‚’**ã™ã¹ã¦ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ**
6. **ã€ŒRunã€** ã‚’ã‚¯ãƒªãƒƒã‚¯

âœ… ã“ã‚Œã§ `design_images` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ï¼

---

### ã‚¹ãƒ†ãƒƒãƒ—2: Edge Functionã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆè‡ªå‹•å‰Šé™¤æ©Ÿèƒ½ï¼‰

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: Supabase CLIï¼ˆæ¨å¥¨ï¼‰

```bash
# Supabase CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆåˆå›ã®ã¿ï¼‰
npm install -g supabase

# Supabaseã«ãƒ­ã‚°ã‚¤ãƒ³
supabase login

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒªãƒ³ã‚¯
supabase link --project-ref dtjnmarztbqpsudmpvvc

# Edge Functionã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
supabase functions deploy cleanup-images
```

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

1. **å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼** â†’ **ã€ŒEdge Functionsã€**
2. **ã€ŒNew Functionã€** ã‚’ã‚¯ãƒªãƒƒã‚¯
3. åå‰: `cleanup-images`
4. `supabase/functions/cleanup-images/index.ts` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ
5. **ã€ŒDeployã€** ã‚’ã‚¯ãƒªãƒƒã‚¯

---

### ã‚¹ãƒ†ãƒƒãƒ—3: Cronã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¨­å®š

1. **Edge Functions** â†’ **`cleanup-images`** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. **ã€ŒCronã€** ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
3. **ã€ŒAdd Cron jobã€** ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«: `0 3 * * *` ï¼ˆæ¯æ—¥åˆå‰3æ™‚ã«å®Ÿè¡Œï¼‰
5. **ã€ŒSaveã€** ã‚’ã‚¯ãƒªãƒƒã‚¯

âœ… ã“ã‚Œã§æ¯æ—¥è‡ªå‹•çš„ã«æœªæ³¨æ–‡ã®å¤ã„ç”»åƒãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### æ‰‹å‹•ã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ

```bash
# Edge Functionã‚’æ‰‹å‹•å®Ÿè¡Œ
curl -X POST \
  https://dtjnmarztbqpsudmpvvc.supabase.co/functions/v1/cleanup-images \
  -H "Authorization: Bearer YOUR_ANON_KEY"
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ç¢ºèª

```sql
-- æœªæ³¨æ–‡ã®ç”»åƒã‚’ç¢ºèª
SELECT id, created_at, ordered, hd_url
FROM design_images
WHERE ordered = false
ORDER BY created_at DESC;

-- 30æ—¥ä»¥å‰ã®æœªæ³¨æ–‡ç”»åƒã‚’ç¢ºèª
SELECT id, created_at, ordered
FROM design_images
WHERE ordered = false
  AND created_at < NOW() - INTERVAL '30 days';
```

---

## ğŸ“Š é‹ç”¨æ–¹æ³•

### å‹•ä½œãƒ•ãƒ­ãƒ¼

1. **ãŠå®¢ã•ã‚“ãŒç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**
   â†’ Supabase Storageã«ä¿å­˜ + `design_images`ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ï¼ˆ`ordered: false`ï¼‰

2. **ãŠå®¢ã•ã‚“ãŒã‚«ãƒ¼ãƒˆã«è¿½åŠ **
   â†’ `ordered: false` ã®ã¾ã¾ï¼ˆæ³¨æ–‡å®Œäº†ã¾ã§å¾…ã¤ï¼‰

3. **æ¯æ—¥åˆå‰3æ™‚ã«è‡ªå‹•å®Ÿè¡Œ**
   â†’ 30æ—¥ä»¥å‰ã®`ordered: false`ç”»åƒã‚’å‰Šé™¤

4. **æ³¨æ–‡å®Œäº†æ™‚ï¼ˆå°†æ¥å®Ÿè£…äºˆå®šï¼‰**
   â†’ Shopify Webhookã§ `ordered: true` ã«æ›´æ–°

---

## ğŸ¯ çµæœ

- **æ³¨æ–‡æ¸ˆã¿ã®ç”»åƒ**: æ°¸ä¹…ä¿å­˜ âœ…
- **æœªæ³¨æ–‡ã®ç”»åƒ**: 30æ—¥å¾Œã«è‡ªå‹•å‰Šé™¤ ğŸ—‘ï¸
- **ã‚«ãƒ¼ãƒˆæ”¾æ£„ã®ç”»åƒ**: 30æ—¥å¾Œã«è‡ªå‹•å‰Šé™¤ ğŸ—‘ï¸
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: ç„¡é§„ãªãåŠ¹ç‡çš„ã«ä½¿ç”¨ ğŸ’¾

---

## ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### å‰Šé™¤æœŸé–“ã‚’å¤‰æ›´ï¼ˆ30æ—¥ â†’ 60æ—¥ãªã©ï¼‰

`supabase/functions/cleanup-images/index.ts` ã®ä»¥ä¸‹ã‚’å¤‰æ›´ï¼š

```typescript
const CLEANUP_DAYS = 60; // 30æ—¥ â†’ 60æ—¥ã«å¤‰æ›´
```

å†ãƒ‡ãƒ—ãƒ­ã‚¤ï¼š
```bash
supabase functions deploy cleanup-images
```

---

## âœ… å®Œäº†ï¼

ã“ã‚Œã§ã€æœªæ³¨æ–‡ã®å¤ã„ç”»åƒãŒè‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼ğŸ‰

**è³ªå•ãŒã‚ã‚Œã°æ°—è»½ã«èã„ã¦ãã ã•ã„ï¼**ğŸ˜Š
